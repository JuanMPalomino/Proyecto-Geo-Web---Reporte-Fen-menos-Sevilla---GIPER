<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta content="IE=edge" http-equiv="X-UA-Compatible"/>
  <meta content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width" name="viewport"/>
  <meta content="yes" name="mobile-web-app-capable"/>
  <meta content="yes" name="apple-mobile-web-app-capable"/>

  <!-- CSS principales -->
  <link href="css/leaflet.css" rel="stylesheet"/>
  <link href="css/L.Control.Locate.min.css" rel="stylesheet"/>
  <link href="css/qgis2web.css" rel="stylesheet"/>
  <link href="css/fontawesome-all.min.css" rel="stylesheet"/>
  <link href="css/leaflet-measure.css" rel="stylesheet"/>

  <!-- Leaflet MarkerCluster CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>

  <!-- Leaflet principal (si lo usás desde local) -->
  <script src="js/leaflet.js"></script>

  <!-- Leaflet MarkerCluster JS (después de leaflet.js) -->
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<style>
  #formularioEvento input,
  #formularioEvento select {
    width: 100%;
    box-sizing: border-box;
  }
</style>
<style>
        html, body, #map {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
        }
        </style>
<title></title>
</head>
<body>
<button id="btnAdmin" style="position:absolute; top:170px; left:10px; z-index:9999; background-color:#343a40; color:white; border:none; padding:10px 15px; border-radius:8px; cursor:pointer; font-weight:bold; box-shadow:2px 2px 8px rgba(0,0,0,0.3);">Registro administrador</button>
<button id="btnCerrarSesion" onclick="cerrarSesionAdmin()" style="position:absolute; top:470px; left:10px; z-index:9999; background-color:#ff0000; color:white; border:none; padding:10px 15px; border-radius:8px; font-weight:bold; display:none; cursor:pointer; box-shadow:2px 2px 8px rgba(0,0,0,0.3);">Cerrar sesión</button><div id="map">
</div>
<script src="js/qgis2web_expressions.js">
function quitarMapaCalor() {
    if (capaCalor) {
        map.removeLayer(capaCalor);
        capaCalor = null;
        document.getElementById('btnQuitarCalor').style.display = 'none';
    }
}

</script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script><script src="js/L.Control.Locate.min.js"></script>
<script src="js/leaflet.rotatedMarker.js"></script>
<script src="js/leaflet.pattern.js"></script>
<script src="js/leaflet-hash.js"></script>
<script src="js/Autolinker.min.js"></script>
<script src="js/rbush.min.js"></script>
<script src="js/labelgun.min.js"></script>
<script src="js/labels.js"></script>
<script src="js/leaflet-measure.js"></script>
<script src="data/Municipios_1.js"></script>
<script src="data/Vas_5.js"></script>
<script src="data/Centrosmdicos_6.js"></script>
<script src="data/Fenmenosnaturales_7.js"></script>
<script>
        var highlightLayer;
        function highlightFeature(e) {
            highlightLayer = e.target;

            if (e.target.feature.geometry.type === 'LineString') {
              highlightLayer.setStyle({
                color: '#ffff00',
              });
            } else {
              highlightLayer.setStyle({
                fillColor: '#ffff00',
                fillOpacity: 1
              });
            }
            highlightLayer.openPopup();
        }
        var map = L.map('map', {
            zoomControl:true, maxZoom:28, minZoom:1
        }).fitBounds([[3.906116610326685,-76.27057185207812],[4.438233851846542,-75.4999129644427]]);
        var hash = new L.Hash(map);
        map.attributionControl.setPrefix('<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; <a href="https://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> &middot; <a href="https://qgis.org">QGIS</a>');
        var autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});
        L.control.locate({locateOptions: {maxZoom: 19}}).addTo(map);
        var measureControl = new L.Control.Measure({
            position: 'topleft',
            primaryLengthUnit: 'meters',
            secondaryLengthUnit: 'kilometers',
            primaryAreaUnit: 'sqmeters',
            secondaryAreaUnit: 'hectares'
        });
        measureControl.addTo(map);
        document.getElementsByClassName('leaflet-control-measure-toggle')[0]
        .innerHTML = '';
        document.getElementsByClassName('leaflet-control-measure-toggle')[0]
        .className += ' fas fa-ruler';
        var bounds_group = new L.featureGroup([]);
        function setBounds() {
        }
        map.createPane('pane_OpenStreetMap_0');
        map.getPane('pane_OpenStreetMap_0').style.zIndex = 100;
        var layer_OpenStreetMap_0 = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            pane: 'pane_OpenStreetMap_0',
            opacity: 1.0,
            attribution: '',
            minZoom: 1,
            maxZoom: 28,
            minNativeZoom: 0,
            maxNativeZoom: 19
        });

// CAPAS WMS DE SUSCEPTIBILIDAD
var wms_remocion = L.tileLayer.wms('http://localhost:8082/geoserver/proyecto_final/wms?', {
    layers: 'proyecto_final:susc_remo',
    format: 'image/png',
    transparent: true,
    attribution: 'GeoServer - Remoción en masa',
    crs: L.CRS.EPSG4326
}).addTo(map);

var wms_inundacion = L.tileLayer.wms('http://localhost:8082/geoserver/proyecto_final/wms?', {
    layers: 'proyecto_final:susc_inun',
    format: 'image/png',
    transparent: true,
    attribution: 'GeoServer - Inundaciones',
    crs: L.CRS.EPSG4326
}).addTo(map);

var wms_avenida = L.tileLayer.wms('http://localhost:8082/geoserver/proyecto_final/wms?', {
    layers: 'proyecto_final:susc_aven',
    format: 'image/png',
    transparent: true,
    attribution: 'GeoServer - Avenidas torrenciales',
    crs: L.CRS.EPSG4326
}).addTo(map);

        layer_OpenStreetMap_0;
        map.addLayer(layer_OpenStreetMap_0);
        function pop_Municipios_1(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (i in e.target._eventParents) {
                        e.target._eventParents[i].resetStyle(e.target);
                    }
                    if (typeof layer.closePopup == 'function') {
                        layer.closePopup();
                    } else {
                        layer.eachLayer(function(feature){
                            feature.closePopup()
                        });
                    }
                },
                mouseover: highlightFeature,
            });
            var popupContent = '<table>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['id'] !== null ? autolinker.link(feature.properties['id'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['nombre'] !== null ? autolinker.link(feature.properties['nombre'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['area'] !== null ? autolinker.link(feature.properties['area'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['perimetro'] !== null ? autolinker.link(feature.properties['perimetro'].toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            layer.bindPopup(popupContent, {maxHeight: 400});
        }

        function style_Municipios_1_0() {
            return {
                pane: 'pane_Municipios_1',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 2.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(196,60,57,0.0)',
                interactive: false,
            }
        }
        map.createPane('pane_Municipios_1');
        map.getPane('pane_Municipios_1').style.zIndex = 401;
        map.getPane('pane_Municipios_1').style['mix-blend-mode'] = 'normal';
        var layer_Municipios_1 = new L.geoJson(json_Municipios_1, {
            attribution: '',
            interactive: false,
            dataVar: 'json_Municipios_1',
            layerName: 'layer_Municipios_1',
            pane: 'pane_Municipios_1',
            onEachFeature: pop_Municipios_1,
            style: style_Municipios_1_0,
        });
        bounds_group.addLayer(layer_Municipios_1);
        map.addLayer(layer_Municipios_1);
        function pop_Susceptibilidadavenidastorrenciales_2(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (i in e.target._eventParents) {
                        e.target._eventParents[i].resetStyle(e.target);
                    }
                    if (typeof layer.closePopup == 'function') {
                        layer.closePopup();
                    } else {
                        layer.eachLayer(function(feature){
                            feature.closePopup()
                        });
                    }
                },
                mouseover: highlightFeature,
            });
            var popupContent = '<table>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['id'] !== null ? autolinker.link(feature.properties['id'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['susc_num'] !== null ? autolinker.link(feature.properties['susc_num'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['susc_cuali'] !== null ? autolinker.link(feature.properties['susc_cuali'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['area'] !== null ? autolinker.link(feature.properties['area'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['perimetro'] !== null ? autolinker.link(feature.properties['perimetro'].toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            layer.bindPopup(popupContent, {maxHeight: 400});
        }

        function style_Susceptibilidadavenidastorrenciales_2_0(feature) {
            switch(String(feature.properties['susc_cuali'])) {
                case 'Muy baja':
                    return {
                pane: 'pane_Susceptibilidadavenidastorrenciales_2',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(165,241,199,1.0)',
                interactive: false,
            }
                    break;
                case 'Baja':
                    return {
                pane: 'pane_Susceptibilidadavenidastorrenciales_2',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(130,251,93,1.0)',
                interactive: false,
            }
                    break;
                case 'Media':
                    return {
                pane: 'pane_Susceptibilidadavenidastorrenciales_2',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(245,241,29,1.0)',
                interactive: false,
            }
                    break;
                case 'Alta':
                    return {
                pane: 'pane_Susceptibilidadavenidastorrenciales_2',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(247,147,25,1.0)',
                interactive: false,
            }
                    break;
                case 'Muy alta':
                    return {
                pane: 'pane_Susceptibilidadavenidastorrenciales_2',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(242,18,67,1.0)',
                interactive: false,
            }
                    break;
            }
        }
        
        function pop_Susceptibilidadinundacin_3(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (i in e.target._eventParents) {
                        e.target._eventParents[i].resetStyle(e.target);
                    }
                    if (typeof layer.closePopup == 'function') {
                        layer.closePopup();
                    } else {
                        layer.eachLayer(function(feature){
                            feature.closePopup()
                        });
                    }
                },
                mouseover: highlightFeature,
            });
            var popupContent = '<table>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['id'] !== null ? autolinker.link(feature.properties['id'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['susc_cuali'] !== null ? autolinker.link(feature.properties['susc_cuali'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['susc_num'] !== null ? autolinker.link(feature.properties['susc_num'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['area'] !== null ? autolinker.link(feature.properties['area'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['perimetro'] !== null ? autolinker.link(feature.properties['perimetro'].toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            layer.bindPopup(popupContent, {maxHeight: 400});
        }

        function style_Susceptibilidadinundacin_3_0(feature) {
            switch(String(feature.properties['susc_cuali'])) {
                case 'Muy baja':
                    return {
                pane: 'pane_Susceptibilidadinundacin_3',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(165,241,199,1.0)',
                interactive: false,
            }
                    break;
                case 'Baja':
                    return {
                pane: 'pane_Susceptibilidadinundacin_3',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(130,251,93,1.0)',
                interactive: false,
            }
                    break;
                case 'Media':
                    return {
                pane: 'pane_Susceptibilidadinundacin_3',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(245,241,29,1.0)',
                interactive: false,
            }
                    break;
                case 'Alta':
                    return {
                pane: 'pane_Susceptibilidadinundacin_3',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(247,147,25,1.0)',
                interactive: false,
            }
                    break;
            }
        }
        
        function pop_Susceptibilidadremocinenmasa_4(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (i in e.target._eventParents) {
                        e.target._eventParents[i].resetStyle(e.target);
                    }
                    if (typeof layer.closePopup == 'function') {
                        layer.closePopup();
                    } else {
                        layer.eachLayer(function(feature){
                            feature.closePopup()
                        });
                    }
                },
                mouseover: highlightFeature,
            });
            var popupContent = '<table>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['susc_cuali'] !== null ? autolinker.link(feature.properties['susc_cuali'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['susc_num'] !== null ? autolinker.link(feature.properties['susc_num'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['id'] !== null ? autolinker.link(feature.properties['id'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['area'] !== null ? autolinker.link(feature.properties['area'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['perimetro'] !== null ? autolinker.link(feature.properties['perimetro'].toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            layer.bindPopup(popupContent, {maxHeight: 400});
        }

        function style_Susceptibilidadremocinenmasa_4_0(feature) {
            switch(String(feature.properties['susc_cuali'])) {
                case 'Muy baja':
                    return {
                pane: 'pane_Susceptibilidadremocinenmasa_4',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(165,241,199,1.0)',
                interactive: false,
            }
                    break;
                case 'Baja':
                    return {
                pane: 'pane_Susceptibilidadremocinenmasa_4',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(130,251,93,1.0)',
                interactive: false,
            }
                    break;
                case 'Media':
                    return {
                pane: 'pane_Susceptibilidadremocinenmasa_4',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(245,241,29,1.0)',
                interactive: false,
            }
                    break;
                case 'Alta':
                    return {
                pane: 'pane_Susceptibilidadremocinenmasa_4',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(247,147,25,1.0)',
                interactive: false,
            }
                    break;
            }
        }
        
        function pop_Vas_5(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (i in e.target._eventParents) {
                        e.target._eventParents[i].resetStyle(e.target);
                    }
                    if (typeof layer.closePopup == 'function') {
                        layer.closePopup();
                    } else {
                        layer.eachLayer(function(feature){
                            feature.closePopup()
                        });
                    }
                },
                mouseover: highlightFeature,
            });
            var popupContent = '<table>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['id'] !== null ? autolinker.link(feature.properties['id'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['x1'] !== null ? autolinker.link(feature.properties['x1'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['y1'] !== null ? autolinker.link(feature.properties['y1'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['x2'] !== null ? autolinker.link(feature.properties['x2'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['y2'] !== null ? autolinker.link(feature.properties['y2'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['source'] !== null ? autolinker.link(feature.properties['source'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['target'] !== null ? autolinker.link(feature.properties['target'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['costo'] !== null ? autolinker.link(feature.properties['costo'].toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            layer.bindPopup(popupContent, {maxHeight: 400});
        }

        function style_Vas_5_0() {
            return {
                pane: 'pane_Vas_5',
                opacity: 1,
                color: 'rgba(141,134,134,1.0)',
                dashArray: '',
                lineCap: 'round',
                lineJoin: 'round',
                weight: 2.0,
                fillOpacity: 0,
                interactive: false,
            }
        }
        map.createPane('pane_Vas_5');
        map.getPane('pane_Vas_5').style.zIndex = 405;
        map.getPane('pane_Vas_5').style['mix-blend-mode'] = 'normal';
        var layer_Vas_5 = new L.geoJson(json_Vas_5, {
            attribution: '',
            interactive: false,
            dataVar: 'json_Vas_5',
            layerName: 'layer_Vas_5',
            pane: 'pane_Vas_5',
            onEachFeature: pop_Vas_5,
            style: style_Vas_5_0,
        });
        bounds_group.addLayer(layer_Vas_5);
        map.addLayer(layer_Vas_5);
        function pop_Centrosmdicos_6(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (i in e.target._eventParents) {
                        e.target._eventParents[i].resetStyle(e.target);
                    }
                    if (typeof layer.closePopup == 'function') {
                        layer.closePopup();
                    } else {
                        layer.eachLayer(function(feature){
                            feature.closePopup()
                        });
                    }
                },
                mouseover: highlightFeature,
            });
            var popupContent = '<table>\
                    <tr>\
                        <th scope="row">ID</th>\
                        <td>' + (feature.properties['id'] !== null ? autolinker.link(feature.properties['id'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Nombre</th>\
                        <td>' + (feature.properties['nombre'] !== null ? autolinker.link(feature.properties['nombre'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Nivel</th>\
                        <td>' + (feature.properties['nivel'] !== null ? autolinker.link(feature.properties['nivel'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Naturaleza</th>\
                        <td>' + (feature.properties['naturaleza'] !== null ? autolinker.link(feature.properties['naturaleza'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Régimen</th>\
                        <td>' + (feature.properties['regimen'] !== null ? autolinker.link(feature.properties['regimen'].toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            layer.bindPopup(popupContent, {maxHeight: 400});
        }

        function style_Centrosmdicos_6_0() {
            return {
                pane: 'pane_Centrosmdicos_6',
                radius: 4.4,
                opacity: 1,
                color: 'rgba(28,16,16,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 2.0,
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(240,12,12,1.0)',
                interactive: true,
            }
        }
        map.createPane('pane_Centrosmdicos_6');
        map.getPane('pane_Centrosmdicos_6').style.zIndex = 406;
        map.getPane('pane_Centrosmdicos_6').style['mix-blend-mode'] = 'normal';
        var layer_Centrosmdicos_6 = new L.geoJson(json_Centrosmdicos_6, {
            attribution: '',
            interactive: true,
            dataVar: 'json_Centrosmdicos_6',
            layerName: 'layer_Centrosmdicos_6',
            pane: 'pane_Centrosmdicos_6',
            onEachFeature: pop_Centrosmdicos_6,
            pointToLayer: function (feature, latlng) {
                var context = {
                    feature: feature,
                    variables: {}
                };
                return L.circleMarker(latlng, style_Centrosmdicos_6_0(feature));
            },
        });
        bounds_group.addLayer(layer_Centrosmdicos_6);
        map.addLayer(layer_Centrosmdicos_6);
        function pop_Fenmenosnaturales_7(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (i in e.target._eventParents) {
                        e.target._eventParents[i].resetStyle(e.target);
                    }
                    if (typeof layer.closePopup == 'function') {
                        layer.closePopup();
                    } else {
                        layer.eachLayer(function(feature){
                            feature.closePopup()
                        });
                    }
                },
                mouseover: highlightFeature,
            });
            var popupContent = '<table>\
                    <tr>\
                        <th scope="row">ID</th>\
                        <td>' + (feature.properties['id'] !== null ? autolinker.link(feature.properties['id'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Tipo</th>\
                        <td>' + (feature.properties['tipo'] !== null ? autolinker.link(feature.properties['tipo'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Categoría de afectación</th>\
                        <td>' + (feature.properties['cate_afec'] !== null ? autolinker.link(feature.properties['cate_afec'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Nivel de afectación</th>\
                        <td>' + (feature.properties['nivel_afec'] !== null ? autolinker.link(feature.properties['nivel_afec'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Fecha</th>\
                        <td>' + (feature.properties['fecha'] !== null ? autolinker.link(feature.properties['fecha'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Afectación de viviendas</th>\
                        <td>' + (feature.properties['afec_vivie'] !== null ? autolinker.link(feature.properties['afec_vivie'].toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Afectación de personas</th>\
                        <td>' + (feature.properties['afect_pers'] !== null ? autolinker.link(feature.properties['afect_pers'].toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            layer.bindPopup(popupContent, {maxHeight: 400});
        }
            var abstract = new L.Control({'position':'bottomleft'});
            abstract.onAdd = function (map) {
                this._div = L.DomUtil.create('div',
                'leaflet-control abstract');
                this._div.id = 'abstract'

                    abstract.show();
                    return this._div;
                };
                abstract.show = function () {
                    this._div.classList.remove("abstract");
                    this._div.classList.add("abstractUncollapsed");
                    this._div.innerHTML = 'Visor para identificación de fenómenos naturales en Sevilla, Valle del Cauca, y la gestión de rutas más cortas para atender escenarios con víctimas humanas';
            };
            abstract.addTo(map);
        var baseMaps = {};
        var controlCapas = L.control.layers(baseMaps, {
  '<img src="legend/Centrosmdicos_6.png" />  Centros médicos': layer_Centrosmdicos_6,
  '<img src="legend/Vas_5.png" />  Vías': layer_Vas_5,

  '<b>Susceptibilidad a Remoción en masa (WMS)</b><br>\
  <div style="margin-left:10px">\
    <div style="background:#A5F1C7; color:black; padding:3px 6px; margin:2px 0; border-radius:3px;">Muy baja</div>\
    <div style="background:#82FB5D; color:black; padding:3px 6px; margin:2px 0; border-radius:3px;">Baja</div>\
    <div style="background:#F5F11D; color:black; padding:3px 6px; margin:2px 0; border-radius:3px;">Moderada</div>\
    <div style="background:#F79319; color:black; padding:3px 6px; margin:2px 0; border-radius:3px;">Alta</div>\
  </div>': wms_remocion,

  '<b>Susceptibilidad a Inundación (WMS)</b><br>\
  <div style="margin-left:10px">\
    <div style="background:#A5F1C7; color:black; padding:3px 6px; margin:2px 0; border-radius:3px;">Muy baja</div>\
    <div style="background:#82FB5D; color:black; padding:3px 6px; margin:2px 0; border-radius:3px;">Baja</div>\
    <div style="background:#F5F11D; color:black; padding:3px 6px; margin:2px 0; border-radius:3px;">Moderada</div>\
    <div style="background:#F79319; color:black; padding:3px 6px; margin:2px 0; border-radius:3px;">Alta</div>\
  </div>': wms_inundacion,

  '<b>Susceptibilidad a Avenidas torrenciales (WMS)</b><br>\
  <div style="margin-left:10px">\
    <div style="background:#A5F1C7; color:black; padding:3px 6px; margin:2px 0; border-radius:3px;">Muy baja</div>\
    <div style="background:#82FB5D; color:black; padding:3px 6px; margin:2px 0; border-radius:3px;">Baja</div>\
    <div style="background:#F5F11D; color:black; padding:3px 6px; margin:2px 0; border-radius:3px;">Moderada</div>\
    <div style="background:#F79319; color:black; padding:3px 6px; margin:2px 0; border-radius:3px;">Alta</div>\
    <div style="background:#F21243; color:black; padding:3px 6px; margin:2px 0; border-radius:3px;">Muy alta</div>\
  </div>': wms_avenida,

  '<img src="legend/Municipios_1.png" />  Municipios': layer_Municipios_1,
  'OpenStreetMap': layer_OpenStreetMap_0
}) .addTo(map);


        setBounds();
        var i = 0;
        layer_Municipios_1.eachLayer(function(layer) {
            var context = {
                feature: layer.feature,
                variables: {}
            };
            layer.bindTooltip((layer.feature.properties['nombre'] !== null?String('<div style="color: #000000; font-size: 6pt; font-family: \'MS Shell Dlg 2\', sans-serif;">' + layer.feature.properties['nombre']) + '</div>':''), {permanent: true, offset: [-0, -16], className: 'css_Municipios_1'});
            labels.push(layer);
            totalMarkers += 1;
              layer.added = true;
              addLabel(layer, i);
              i++;
        });
        resetLabels([layer_Municipios_1]);
        map.on("zoomend", function(){
            resetLabels([layer_Municipios_1]);
        });
        map.on("layeradd", function(){
            resetLabels([layer_Municipios_1]);
        });
        map.on("layerremove", function(){
            resetLabels([layer_Municipios_1]);
        });
        </script>
<!-- BOTÓN flotante -->
<style>
    #btnRegistro {
        position: absolute;
        top: 120px;
        right: 10px;
        z-index: 9999;
        background-color: #dc3545;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        box-shadow: 2px 2px 8px rgba(0,0,0,0.3);
    }

    #formularioEvento {
        position: absolute;
        top: 70px;
        right: 10px;
        z-index: 9999;
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 2px 2px 10px rgba(0,0,0,0.2);
        display: none;
        width: 260px;
        font-size: 14px;
    }

    #formularioEvento select,
    #formularioEvento input {
        width: 100%;
        margin-bottom: 10px;
        padding: 5px;
    }

    #formularioEvento label {
        font-weight: bold;
    }
</style>
<button id="btnRegistro" style="
  position: absolute;
  top: 220px;
  left: 10px;
  z-index: 9999;
  background-color: #f93b12;
  color: white;
  border: none;
  padding: 10px 15px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
  box-shadow: 2px 2px 8px rgba(0,0,0,0.3);
  width: auto;
  max-width: 150px;
  white-space: nowrap;
">Registrar evento</button>

<!-- NUEVO: Botón "Editar registro" -->
<button id="btnEditarRegistro" style="
  display: none;
  position: absolute;
  top: 220px;
  left: 10px;
  z-index: 9999;
  background-color: #28a745;
  color: white;
  border: none;
  padding: 10px 15px;
  border-radius: 8px;
  font-weight: bold;
  cursor: pointer;
  box-shadow: 2px 2px 8px rgba(0,0,0,0.3);
">Editar evento</button>
<div id="formularioEvento" style="position:absolute; top:120px; right:1025px; z-index:10001; background:white; padding:10px; border-radius:10px; display:none; box-shadow: 2px 2px 10px rgba(0,0,0,0.2); width:300px;"><button id="cerrarEvento" onclick="document.getElementById('formularioEvento').style.display='none';" style="float:right; background:red; color:white; margin-bottom:5px;">Cerrar</button>
<label>Coordenadas:</label>
<input id="coordLat" readonly="" style="background-color:#eee;" type="text"/>
<input id="coordLng" readonly="" style="background-color:#eee;" type="text"/>
<label>Nombre:</label>
<input id="nombre" type="text"/>
<label>Tipo de evento:</label>
<select id="evento">
<option value="Inundación">Inundación</option>
<option value="Remoción en masa">Remoción en masa</option>
<option value="Avenida torrencial">Avenida torrencial</option>
</select>
<label>¿Cuántas personas heridas?</label>
<input id="numHeridos" min="0" type="number"/>
<label>¿Qué tan grave está la persona herida?</label>
<select id="gravedad">
<option value="No tan grave">No tan grave</option>
<option value="Grave">Grave</option>
<option value="Muy grave">Muy grave</option>
</select>
<p id="mensajeGravedad" style="margin-top:5px;"></p>
<!-- <button onclick="formularioEvento.style.display='none'" style="margin-right:5px;">Cerrar</button> -->

<label>¿Cuántas viviendas afectadas?</label><input id="viviendasAfectadas" min="0" type="number"/><label>¿Qué tan grave fue el fenómeno?</label><select id="gravedadFenomeno"><option value="Leve">Leve</option><option value="Moderado">Moderado</option><option value="Grave">Grave</option></select><button onclick="guardarReporte()">Guardar reporte</button>
</div>
<!-- FORMULARIO INDEPENDIENTE PARA EDITAR EVENTOS -->
<div id="formularioEdicion" style="position:absolute; top:120px; right:1025px; z-index:10001; background:white; padding:10px; border-radius:10px; display:none; box-shadow: 2px 2px 10px rgba(0,0,0,0.2); width:300px;">
  <button id="cerrarEdicion" onclick="document.getElementById('formularioEdicion').style.display='none';" style="float:right; background:red; color:white; margin-bottom:5px;">Cerrar</button>

  <input id="idEventoEditar" type="hidden"/>

  <label>Coordenadas:</label><br/>
  <input id="coordLatEdit" readonly style="background-color:#eee; width:140px; display:inline-block;" type="text"/>
  <input id="coordLngEdit" readonly style="background-color:#eee; width:140px; display:inline-block;" type="text"/><br/>

  <label>Nombre:</label>
  <input id="nombreEdit" type="text" style="width:100%;"/>

  <label>Tipo de evento:</label>
  <select id="eventoEdit" style="width:100%;">
    <option value="Inundación">Inundación</option>
    <option value="Remoción en masa">Remoción en masa</option>
    <option value="Avenida torrencial">Avenida torrencial</option>
  </select>

  <label>¿Cuántas personas heridas?</label>
  <input id="numHeridosEdit" min="0" type="number" style="width:100%;"/>

  <label>¿Qué tan grave está la persona herida?</label>
  <select id="gravedadEdit" style="width:100%;">
    <option value="No tan grave">No tan grave</option>
    <option value="Grave">Grave</option>
    <option value="Muy grave">Muy grave</option>
  </select>

  <p id="mensajeGravedadEdit" style="margin-top:5px;"></p>

  <label>¿Cuántas viviendas afectadas?</label>
  <input id="viviendasAfectadasEdit" min="0" type="number" style="width:100%;"/>

  <label>¿Qué tan grave fue el fenómeno?</label>
  <select id="gravedadFenomenoEdit" style="width:100%;">
    <option value="Leve">Leve</option>
    <option value="Moderado">Moderado</option>
    <option value="Grave">Grave</option>
  </select>

  <button onclick="confirmarEdicion()" style="margin-top:8px;">Confirmar edición</button>
</div>



<script>
	let modoEliminarActivo = false;
    let registroActivo = false;
    let marcadorTemporal;

    document.getElementById('btnRegistro').addEventListener('click', function () {
        alert("Seleccione un lugar en el mapa para registrar el evento.");
        registroActivo = true;
    });

    map.on('click', function (e) {
        if (!registroActivo) return;

        if (marcadorTemporal) {
            map.removeLayer(marcadorTemporal);
        }

        marcadorTemporal = L.marker(e.latlng).addTo(map);
        const lat = e.latlng.lat.toFixed(6);
        const lng = e.latlng.lng.toFixed(6);

        document.getElementById('coordLat').value = lat;
        document.getElementById('coordLng').value = lng;

        document.getElementById('formularioEvento').style.display = 'block';
        registroActivo = false;
    });

    
  
    document.getElementById('gravedad').addEventListener('change', function () {
        const msg = {
            'No tan grave': 'Se recomienda asistir a centros médicos de nivel 1.',
            'Grave': 'Se recomienda ir a centros médicos de nivel 2.',
            'Muy grave': 'Se recomienda ir a centros médicos de nivel 3.'
        };
        document.getElementById('mensajeGravedad').innerText = msg[this.value];
    });
</script>
<script>
function guardarReporte() {
    const datos = {
        viviendas_afectadas: document.getElementById('viviendasAfectadas').value || 0,
        gravedad_fenomeno: document.getElementById('gravedadFenomeno').value,
        latitud: document.getElementById('coordLat').value,
        longitud: document.getElementById('coordLng').value,
        nombre: document.getElementById('nombre').value,
        tipo_evento: document.getElementById('evento').value,
        numero_heridos: document.getElementById('numHeridos').value || 0,
        gravedad: document.getElementById('gravedad').value
    };

    fetch('guardar_evento.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(datos)
    })
    .then(response => response.text())
    .then(data => {
        alert("✅ " + data);
        formularioEvento.style.display = 'none';

        // Agregar el nuevo marcador directamente
        const latlng = [parseFloat(datos.latitud), parseFloat(datos.longitud)];
        const emojiIcon = L.divIcon({
            className: 'emoji-marker',
            html: '<div style="font-size: 20px;">📍</div>',
            iconSize: [22, 22],
            iconAnchor: [11, 22]
        });

        const popup = `
            <b>Nombre:</b> ${datos.nombre}<br>
            <b>Tipo:</b> ${datos.tipo_evento}<br>
            <b>Heridos:</b> ${datos.numero_heridos}<br>
            <b>Gravedad:</b> ${datos.gravedad}<br>
            <b>Viviendas afectadas:</b> ${datos.viviendas_afectadas}<br>
            <b>Gravedad del fenómeno:</b> ${datos.gravedad_fenomeno}<br>
            <b>Fecha:</b> (recién reportado)
        `;

        const nuevo = L.marker(latlng, { icon: emojiIcon, pane: 'paneEventos' }).addTo(map);
        nuevo.bindPopup(popup);
    })
    .catch(error => {
        console.error('Error al guardar:', error);
        alert("❌ No se pudo guardar el evento.");
    });
}
</script>
<style>
#btnRuta {
    position: absolute;
    top: 180px;
    right: 10px;
    z-index: 9999;
    background-color: #007bff;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    box-shadow: 2px 2px 8px rgba(0,0,0,0.3);
}
#menuRuta {
    position: absolute;
    top: 130px;
    right: 10px;
    z-index: 9999;
    background: white;
    padding: 10px;
    border-radius: 8px;
    display: none;
    box-shadow: 2px 2px 10px rgba(0,0,0,0.2);
    font-size: 14px;
}
</style>
<button id="btnRuta" style="position:absolute; top:270px; left:10px; z-index:9999; background-color:#007bff; color:white; border:none; padding:10px 15px; border-radius:8px; cursor:pointer; font-weight:bold; cursor: pointer; width: auto; max-width: 135px; white-space: nowrap; box-shadow:2px 2px 8px rgba(0,0,0,0.3);">Ver ruta médica</button>
<!-- NUEVO: Botón "Eliminar registro" -->
<button id="btnEliminarRegistro" onclick="activarModoEliminar()" style="
  display: none;
  position: absolute;
  top: 270px;
  left: 10px;
  z-index: 9999;
  background-color: #dc3545;
  color: white;
  border: none;
  padding: 10px 15px;
  border-radius: 8px;
  font-weight: bold;
  cursor: pointer;
  box-shadow: 2px 2px 8px rgba(0,0,0,0.3);
">Eliminar evento</button>
<div id="menuRuta" style="position:absolute; top:240px; left:200px; z-index:10001; background:white; padding:10px; border-radius:10px; display:none; box-shadow: 2px 2px 10px rgba(0,0,0,0.2); font-size:14px; width:300px;">
  <button id="cerrarRuta" onclick="document.getElementById('menuRuta').style.display='none';" style="float:right; background:red; color:white; margin-bottom:5px;">Cerrar</button>
<p><b>¿Qué ruta desea ver?</b></p>
<input name="nivel" type="radio" value="1"/> Centros médicos nivel 1<br/>
<input name="nivel" type="radio" value="2"/> Centros médicos nivel 2<br/>
<input name="nivel" type="radio" value="3"/> Centros médicos nivel 3<br/><br/>
<button id="btnAceptarNivel">Aceptar</button><br/><br/>
<select id="listaCentros" style="display:none; width:100%; margin-top:5px;"></select>
<button id="btnVerRuta" style="display:none; margin-top:5px;">Mostrar ruta</button>
</div>

<script>
document.getElementById('btnRuta').onclick = () => {
    const menu = document.getElementById('menuRuta');
    menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
};

document.getElementById('btnAceptarNivel').onclick = () => {
    const nivel = document.querySelector('input[name="nivel"]:checked');
    if (!nivel) return alert("Seleccione un nivel.");

    const nivelSeleccionado = nivel.value;
    const lista = document.getElementById('listaCentros');
    lista.innerHTML = '';

    const centros = json_Centrosmdicos_6.features.filter(f => f.properties.nivel == nivelSeleccionado);
    centros.forEach(f => {
        const opt = document.createElement('option');
        opt.value = f.properties.id;
        opt.text = f.properties.nombre;
        lista.appendChild(opt);
    });

    if (centros.length === 0) {
        alert("No hay centros médicos con ese nivel.");
        return;
    }

    lista.style.display = 'block';
    document.getElementById('btnVerRuta').style.display = 'block';
};

let capaRuta;
map.createPane('paneRuta');
map.getPane('paneRuta').style.zIndex = 999;

document.getElementById('btnVerRuta').onclick = () => {
    const idCentro = document.getElementById('listaCentros').value;
    const lat = document.getElementById('coordLat').value;
    const lng = document.getElementById('coordLng').value;

    if (!lat || !lng) {
        alert("Primero debe marcar un punto en el mapa usando 'Registrar evento'.");
        return;
    }

    fetch('ruta_medica.php', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ lat: parseFloat(lat), lng: parseFloat(lng), id: parseInt(idCentro) })
    })
    .then(resp => resp.json())
    .then(geojson => {
        console.log("GeoJSON recibido:", geojson);

        if (capaRuta) map.removeLayer(capaRuta);

        const lineas = [];
        geojson.features.forEach(f => {
            if (f.geometry.type === 'MultiLineString') {
                f.geometry.coordinates.forEach(coords => {
                    lineas.push({
                        type: 'Feature',
                        geometry: { type: 'LineString', coordinates: coords },
                        properties: f.properties
                    });
                });
            } else {
                lineas.push(f);
            }
        });

        capaRuta = L.geoJSON({type: 'FeatureCollection', features: lineas}, {
            style: {color: 'red', weight: 6, opacity: 0.95, dashArray: '5,4'}, pane: 'paneRuta'
        }).addTo(map);
        map.fitBounds(capaRuta.getBounds());
        document.getElementById('btnQuitarRuta').style.display = 'block';
    })
    .catch(err => {
        alert("Error al calcular la ruta");
        console.error(err);
    });
};
</script>
<div id="formularioAdmin" style="position:absolute; top:50px; right:1050px; z-index:9999; background:white; padding:15px; border-radius:8px; box-shadow:2px 2px 10px rgba(0,0,0,0.2); display:none; width:260px; font-size:14px;">
<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
<strong>Ingreso administrador</strong>
<button onclick="document.getElementById('formularioAdmin').style.display='none';" style="background:red; color:white; border:none; padding:4px 8px; font-size:12px; border-radius:4px; cursor:pointer;">Cerrar</button>
</div>
<label>Usuario:</label>
<input id="adminUser" style="width:100%; margin-bottom:10px;" type="text"/>
<label>Contraseña:</label>
<input id="adminPass" style="width:100%; margin-bottom:10px;" type="password"/>
<button onclick="loginAdmin()" style="width:100%; margin-bottom:10px;">Ingresar</button>
<p id="adminMensaje" style="margin-top:5px;"></p>
</div>
<script>
let geojson = null;

// Crear el pane de eventos ANTES de cargar capas
map.createPane('paneEventos');
map.getPane('paneEventos').style.zIndex = 200;
map.getPane('paneEventos').style['mix-blend-mode'] = 'normal';

const emojiIcon = L.divIcon({
  className: 'emoji-marker',
  html: '<div style="font-size: 20px;">📍</div>',
  iconSize: [22, 22],
  iconAnchor: [11, 22]
});

function activarModoEliminar() {
  modoEliminarActivo = true;
  alert("Seleccione el registro que desea eliminar.");
}

function onEachFeatureConEliminacion(feature, layer) {
  const p = feature.properties;
  const popup = `
    <b>Nombre:</b> ${p.nombre}<br>
    <b>Tipo:</b> ${p.tipo_evento}<br>
    <b>Heridos:</b> ${p.numero_heridos}<br>
    <b>Gravedad:</b> ${p.gravedad}<br>
    <b>Viviendas afectadas:</b> ${p.viviendas_afectadas}<br>
    <b>Gravedad del fen\u00f3meno:</b> ${p.gravedad_fenomeno}<br>
    <b>Fecha:</b> ${p.fecha_reporte}
  `;
  layer.bindPopup(popup);

  layer.on('click', function () {
    if (!modoEliminarActivo) return;
    const confirmado = confirm("\u00bfSeguro que desea eliminar el registro?");
    if (confirmado) {
      eliminarRegistro(feature, layer);
    } else {
      modoEliminarActivo = false;
    }
  });
}

function eliminarRegistro(feature, layer) {
  const id = feature.properties.id;
  if (!id) {
    alert("\u274c Este registro no tiene ID.");
    return;
  }
  fetch('eliminar_evento.php', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ id: id })
  })
    .then(response => response.json())
    .then(data => {
      if (data.status === "OK") {
        map.removeLayer(layer);
        alert("\u2705 Registro eliminado correctamente.");
      } else {
        alert("\u274c No se pudo eliminar el registro.");
      }
      modoEliminarActivo = false;
    })
    .catch(() => {
      alert("\u26a0\ufe0f Error de conexi\u00f3n.");
      modoEliminarActivo = false;
    });
}
function obtenerIconoPorTipo(tipo) {
  let iconUrl;

  if (tipo === 'Inundación') {
    iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png';
  } else if (tipo === 'Remoción en masa') {
    iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-grey.png';
  } else if (tipo === 'Avenida torrencial') {
    iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-orange.png';
  } else {
    iconUrl = 'https://maps.google.com/mapfiles/ms/icons/red-dot.png'; // por defecto
  }

  return L.icon({
    iconUrl: iconUrl,
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34]
  });
}

function crearCapaFiltrada(tipo) {
  return L.geoJSON(geojson, {
    filter: function (feature) {
      return feature.properties.tipo_evento === tipo;
    },
    pointToLayer: function (feature, latlng) {
      return L.marker(latlng, { icon: obtenerIconoPorTipo(feature.properties.tipo_evento), pane: 'paneEventos' });
    },
    onEachFeature: onEachFeatureConEliminacion
  }).addTo(map);
}

fetch('eventos_geojson.php')
  .then(response => response.json())
  .then(data => {
    geojson = data;
    console.log("Eventos recibidos:", geojson);

    if (!geojson.features || geojson.features.length === 0) {
      alert("No hay eventos disponibles en el geojson.");
      return;
    }

    const capaInundacion = crearCapaFiltrada('Inundaci\u00f3n');
    const capaRemocion = crearCapaFiltrada('Remoci\u00f3n en masa');
    const capaAvenida = crearCapaFiltrada('Avenida torrencial');

    controlCapas.addOverlay(capaInundacion, '<img src="https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png" style="width:15px; vertical-align:middle;"> Inundación');
	controlCapas.addOverlay(capaRemocion, '<img src="https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-grey.png" style="width:15px; vertical-align:middle;"> Remoción en masa');
	controlCapas.addOverlay(capaAvenida, '<img src="https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-orange.png" style="width:15px; vertical-align:middle;"> Avenida torrencial');

  })
  .catch(error => {
    console.error("Error cargando eventos:", error);
    alert("❌ No se pudieron cargar los eventos desde la base de datos.");
  });
</script>

<!-- Botón y menú de mapa de calor -->
<style>
#btnMapaCalor {
    position: absolute;
    top: 240px;
    right: 10px;
    z-index: 9999;
    background-color: #f39c12;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    box-shadow: 2px 2px 8px rgba(0,0,0,0.3);
}
#menuMapaCalor {
    position: absolute;
    top: 290px;
    right: 10px;
    z-index: 9999;
    background: white;
    padding: 10px;
    border-radius: 8px;
    display: none;
    box-shadow: 2px 2px 10px rgba(0,0,0,0.2);
    font-size: 14px;
}
</style>
<button id="btnMapaCalor" style="position:absolute; top:320px; left:10px; z-index:9999; background-color:#e1ca0c; color:white; border:none; padding:10px 15px; border-radius:8px; cursor:pointer; font-weight:bold; cursor: pointer; width: auto; max-width: 140px; white-space: nowrap; box-shadow:2px 2px 8px rgba(0,0,0,0.3);">Mapas de calor</button>
<div id="menuMapaCalor" style="display: none; position: absolute; top: 280px; right: 1070px; width: 250px; background-color: white; border: 2px solid #ccc; border-radius: 8px;
  padding: 10px; box-shadow: 2px 2px 8px rgba(0,0,0,0.3); z-index: 10001;">
<button onclick="document.getElementById('menuMapaCalor').style.display='none';" style="float:right; background:red; color:white; margin-bottom:5px;">Cerrar</button>
<p><b>¿Qué mapa de calor desea ver?</b></p>
<select id="tipoCalor">
<option value="Inundación">Mapa de calor: Inundaciones</option>
<option value="Remoción en masa">Mapa de calor: Remoción en masa</option>
<option value="Avenida torrencial">Mapa de calor: Avenida torrencial</option>
<option value="todos">Mapa de calor: Todos los fenómenos</option>
</select>
<button onclick="generarMapaCalor()" style="margin-top:10px;">Generar</button>
</div>
<!-- Botón para quitar mapa de calor -->
<!-- Botón para quitar mapa de calor -->
<!-- Botón para quitar mapa de calor -->
<!-- Botón para quitar mapa de calor -->
<!-- Botón para quitar mapa de calor -->
<!-- Botón para quitar mapa de calor -->
<!-- Botón para quitar mapa de calor -->
<!-- Botón para quitar mapa de calor -->
<!-- Botón para quitar mapa de calor -->
<!-- Botón para quitar mapa de calor -->
<!-- Botón para quitar mapa de calor -->
<button id="btnQuitarCalor" onclick="quitarMapaCalor()" style="
  position: absolute;
  top: 370px;             /* un poco debajo del panel */
  right: 1078px;          /* mismo 'right' que el panel */
  z-index: 10001;
  display: none;
  background-color: #6c757d;
  color: white;
  border: 2px solid black;
  padding: 4px 12px;
  font-size: 12px;
  font-weight: bold;
  border-radius: 0px;
  cursor: pointer;
  box-shadow: 1px 1px 6px rgba(0,0,0,0.2);
">Quitar</button>
<button id="btnCluster" style="
    position: absolute;
    top: 370px;
    left: 10px;
    z-index: 1000;
    background-color: #17a2b8;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    box-shadow: 2px 2px 8px rgba(0,0,0,0.3);
">Agrupación (Clúster)</button>

<script>
function cerrarSesionAdmin() {
    document.getElementById('btnRegistro').style.display = 'block';
    document.getElementById('btnRuta').style.display = 'block';
	document.getElementById('btnEditarRegistro').style.display = 'none';
	document.getElementById('btnEliminarRegistro').style.display = 'none';
    document.getElementById('btnCerrarSesion').style.display = 'none';
    alert("¡Sesión de administrador cerrada exitosamente!");
}
</script><script>
const btnMapaCalor = document.getElementById('btnMapaCalor');
const originalMapaTop = btnMapaCalor.style.top || '240px';

function moverMapaCalorArriba() {
    btnMapaCalor.style.top = '180px';
}

function restaurarPosicionMapaCalor() {
    btnMapaCalor.style.top = originalMapaTop;
}

function cerrarSesionAdmin() {
    document.getElementById('btnRegistro').style.display = 'block';
    document.getElementById('btnRuta').style.display = 'block';
	document.getElementById('btnEditarRegistro').style.display = 'none';
	document.getElementById('btnEliminarRegistro').style.display = 'none';
    document.getElementById('btnCerrarSesion').style.display = 'none';
    restaurarPosicionMapaCalor();
    alert("¡Sesión de administrador cerrada exitosamente!");
}
</script><button id="btnQuitarRuta" onclick="quitarRuta()" style="position:absolute; top:370px; right:1025px; z-index:10001; display:none; background-color:#6c757d; color:white; border:none; padding:2px 8px; font-size:13px; font-weight:bold; border-radius:4px; cursor:pointer;">Quitar</button><script>
function quitarRuta() {
    if (capaRuta) {
        map.removeLayer(capaRuta);
        capaRuta = null;
        document.getElementById('btnQuitarRuta').style.display = 'none';
    }
}
</script><script>
function mostrarFormularioEvento() {
    document.getElementById('formularioEvento').style.display = 'block';
    document.getElementById('btnMapaCalor').style.display = 'none';
    document.getElementById('btnRuta').style.display = 'none';
}

function cerrarFormularioEvento() {
    document.getElementById('formularioEvento').style.display = 'none';
    document.getElementById('btnMapaCalor').style.display = 'block';
    document.getElementById('btnRuta').style.display = 'block';
}

function mostrarMenuRuta() {
    document.getElementById('menuRuta').style.display = 'block';
    document.getElementById('btnMapaCalor').style.display = 'none';
}

function cerrarMenuRuta() {
    document.getElementById('menuRuta').style.display = 'none';
    document.getElementById('btnMapaCalor').style.display = 'block';
    document.getElementById('btnQuitarRuta').style.display = 'none';
}
</script><script>
function mostrarFormularioEvento() {
    document.getElementById('formularioEvento').style.display = 'block';
    document.getElementById('btnMapaCalor').style.display = 'none';
    document.getElementById('btnRuta').style.display = 'none';
}

function cerrarFormularioEvento() {
    document.getElementById('formularioEvento').style.display = 'none';
    document.getElementById('btnMapaCalor').style.display = 'block';
    document.getElementById('btnRuta').style.display = 'block';
}

function mostrarMenuRuta() {
    document.getElementById('menuRuta').style.display = 'block';
    document.getElementById('btnMapaCalor').style.display = 'none';
}

function cerrarMenuRuta() {
    document.getElementById('menuRuta').style.display = 'none';
    document.getElementById('btnMapaCalor').style.display = 'block';
    document.getElementById('btnQuitarRuta').style.display = 'none';
}
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('btnAdmin').onclick = () => {
      const f = document.getElementById('formularioAdmin');
      f.style.display = f.style.display === 'block' ? 'none' : 'block';
  };

  window.loginAdmin = function () {
      const user = document.getElementById('adminUser').value.trim();
      const pass = document.getElementById('adminPass').value.trim();

      fetch('login_admin.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ usuario: user, clave: pass })
      })
      .then(response => response.text())
      .then(data => {
          document.getElementById('adminMensaje').innerHTML = data;
          if (data.includes("✅")) {
              document.getElementById('btnRegistro').style.display = 'none';
              document.getElementById('btnRuta').style.display = 'none';
              document.getElementById('btnEditarRegistro').style.display = 'block';
              document.getElementById('btnEliminarRegistro').style.display = 'block';
              document.getElementById('btnCerrarSesion').style.display = 'block';
              document.getElementById('formularioAdmin').style.display = 'none';
          }
      })
      .catch(error => {
          document.getElementById('adminMensaje').innerHTML = '❌ Error de conexión.';
      });
  }
});
</script>
<script>
// Activar el modo edición desde el botón existente
let modoEdicionActivo = false;

document.getElementById('btnEditarRegistro').addEventListener('click', () => {
  alert('Seleccione el evento a editar');
  modoEdicionActivo = true;
});

// Detectar capas ya existentes y agregar evento de clic dinámicamente
let edicionInicializada = false;

const activarClicksDeEdicion = setInterval(() => {
  if (edicionInicializada || !modoEdicionActivo) return;

  map.eachLayer(layer => {
    if (layer.feature && layer.feature.properties && !layer._edicionVinculada) {
      layer.on('click', () => {
        if (!modoEdicionActivo) return;
        cargarFormularioEdicion(layer.feature);
        modoEdicionActivo = false;
      });
      layer._edicionVinculada = true; // Evita duplicar eventos
    }
  });

  edicionInicializada = true;
}, 500);

// Mostrar formulario con datos cargados
function cargarFormularioEdicion(feature) {
  document.getElementById('formularioEdicion').style.display = 'block';

  document.getElementById('idEventoEditar').value = feature.properties.id;
  document.getElementById('coordLatEdit').value = feature.geometry.coordinates[1];
  document.getElementById('coordLngEdit').value = feature.geometry.coordinates[0];
  document.getElementById('nombreEdit').value = feature.properties.nombre;
  document.getElementById('eventoEdit').value = feature.properties.tipo_evento;
  document.getElementById('numHeridosEdit').value = feature.properties.numero_heridos;
  document.getElementById('gravedadEdit').value = feature.properties.gravedad;
  document.getElementById('viviendasAfectadasEdit').value = feature.properties.viviendas_afectadas;
  document.getElementById('gravedadFenomenoEdit').value = feature.properties.gravedad_fenomeno;
}

// Enviar edición al backend
function confirmarEdicion() {
  if (!confirm("¿Está seguro de editar el registro?")) return;

  const datos = {
    id: document.getElementById('idEventoEditar').value,
    latitud: document.getElementById('coordLatEdit').value,
    longitud: document.getElementById('coordLngEdit').value,
    nombre: document.getElementById('nombreEdit').value,
    tipo_evento: document.getElementById('eventoEdit').value,
    numero_heridos: document.getElementById('numHeridosEdit').value,
    gravedad: document.getElementById('gravedadEdit').value,
    viviendas_afectadas: document.getElementById('viviendasAfectadasEdit').value,
    gravedad_fenomeno: document.getElementById('gravedadFenomenoEdit').value
  };

  fetch('editar_evento.php', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(datos)
  })
  .then(resp => resp.json())
  .then(data => {
    if (data.success) {
      alert("✅ " + data.mensaje + " Recargue el visor para ver el cambio");
      document.getElementById('formularioEdicion').style.display = 'none';	  
    } else {
      alert("❌ Error: " + (data.mensaje || "No se pudo editar el registro."));
    }
  })
  .catch(error => {
    console.error("Error en la petición:", error);
    alert("❌ Error de conexión con el servidor.");
  });
}
</script>

</body>
<script>
let capaCalor;

document.getElementById('btnMapaCalor').onclick = () => {
    const menu = document.getElementById('menuMapaCalor');
    menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
};

function generarMapaCalor() {
    document.getElementById('btnQuitarCalor').style.display = 'block';
    const tipo = document.getElementById('tipoCalor').value;

    fetch('mapa_calor.php?tipo=' + tipo)
        .then(resp => resp.json())
        .then(puntos => {
            if (capaCalor) map.removeLayer(capaCalor);

            capaCalor = L.heatLayer(puntos, {
                radius: 40,
                blur: 1,
                maxZoom: 13,
                gradient: {
                    0.1: '#330066',   // morado oscuro
                    0.3: '#660099',   // púrpura fuerte
                    0.5: '#cc0066',   // rosado encendido
					0.7: '#ff3300',   // naranja rojo
					1.0: '#990000'    // rojo sangre
                }
            }).addTo(map);
        })
        .catch(error => {
            console.error("❌ Error al cargar mapa de calor:", error);
            alert("No se pudo cargar el mapa de calor.");
        });
}

function quitarMapaCalor() {
    if (capaCalor) {
        map.removeLayer(capaCalor);
        capaCalor = null;
        document.getElementById('btnQuitarCalor').style.display = 'none';
    }
}

</script>
<script>
let capaCluster = null;
let clusterVisible = false;

document.getElementById('btnCluster').onclick = () => {
    if (!capaCluster) {
        fetch('cluster.php')
            .then(resp => resp.json())
            .then(geojson => {
                const emojiIcon = L.divIcon({
                    className: 'emoji-marker',
                    html: '<div style="font-size: 20px;"></div>',
                    iconSize: [22, 22],
                    iconAnchor: [11, 22]
                });

                const grupo = L.markerClusterGroup();

                const capa = L.geoJSON(geojson, {
                    pointToLayer: function (feature, latlng) {
                        return L.marker(latlng, { icon: emojiIcon });
                    },
                    onEachFeature: function (feature, layer) {
                        const p = feature.properties || {};
                        const popup = `
                            <b>Nombre:</b> ${p.nombre ?? '---'}<br>
                            <b>Tipo:</b> ${p.tipo_evento ?? '---'}<br>
                            <b>Heridos:</b> ${p.numero_heridos ?? '---'}<br>
                            <b>Gravedad:</b> ${p.gravedad ?? '---'}<br>
                            <b>Viviendas afectadas:</b> ${p.viviendas_afectadas ?? '---'}<br>
                            <b>Gravedad del fenómeno:</b> ${p.gravedad_fenomeno ?? '---'}<br>
                            <b>Fecha:</b> ${p.fecha_reporte ?? '---'}
                        `;
                        layer.bindPopup(popup);
                    }
                });

                grupo.addLayer(capa);
                capaCluster = grupo;
                map.addLayer(capaCluster);
                clusterVisible = true;
                document.getElementById('btnCluster').innerText = "Ocultar Clúster";
            })
            .catch(err => {
                console.error("Error cargando clúster:", err);
                alert("❌ No se pudo cargar la capa de clúster.");
            });
    } else {
        if (clusterVisible) {
            map.removeLayer(capaCluster);
            document.getElementById('btnCluster').innerText = "Agrupación (Clúster)";
        } else {
            map.addLayer(capaCluster);
            document.getElementById('btnCluster').innerText = "Ocultar Clúster";
        }
        clusterVisible = !clusterVisible;
    }
};
</script>

<button id="btnGraficos" style="
  position: absolute;
  top: 420px;
  left: 10px;
  z-index: 1000;
  background-color: #28d165;
  color: white;
  border: none;
  padding: 10px 15px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
  box-shadow: 2px 2px 8px rgba(0,0,0,0.3);
">Generación de gráficos</button>

<div id="modalGraficos" style="
  display: none;
  position: fixed;
  top: 15px;
  right: 850px;
  width: 450px;
  background: white;
  padding: 20px;
  border-radius: 10px;
  z-index: 10000;
  box-shadow: 0 0 20px rgba(0,0,0,0.4);
">
  <button onclick="document.getElementById('modalGraficos').style.display='none'"
    style="float: right; border: none; background: none; font-size: 20px; cursor: pointer;">×</button>

  <div style="display: flex; justify-content: space-between; align-items: center;">
  <h3 style="margin: 0;">📊 GENERADOR DE GRÁFICOS</h3>
</div>



  <label for="fuenteDatos"><b>Fuente de datos:</b></label>
  <select id="fuenteDatos" style="width: 100%; margin-bottom: 10px;">
    <option value="">-- Selecciona --</option>
    <option value="centros_medicos">Centros Médicos</option>
    <option value="reportes_eventos">Reportes de Eventos</option>
  </select>

  <label for="tipoGrafico"><b>Gráfico:</b></label>
  <select id="tipoGrafico" style="width: 100%; margin-bottom: 10px;"></select>

  <button id="btnGenerarGrafico" style="
    width: 100%;
    padding: 10px;
    background-color: #28a745;
    color: white;
    border: none;
    border-radius: 6px;
    font-weight: bold;
    cursor: pointer;
  ">Generar gráfico</button>

  <div style="margin-top: 20px;">
    <canvas id="canvasGrafico"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let graficoActual = null;

const opcionesPorTabla = {
  centros_medicos: {
    "nivel": "Cantidad de centros médicos según su Nivel",
    "naturaleza": "Naturaleza del centro médico",
    "regimen": "Régimen de afiliación"
  },
  reportes_eventos: {
    "tipo_evento": "Cantidad de tipo de eventos reportados",
    "heridos_por_tipo": "Número de heridos por tipo de evento",
    "gravedad": "Categoría de gravedad de los heridos",
    "viviendas_afectadas": "Número de viviendas afectadas por el tipo de fenómeno",
    "gravedad_fenomeno": "Gravedad del fenómeno natural"
  }
};

document.getElementById('btnGraficos').onclick = () => {
  document.getElementById('modalGraficos').style.display = 'block';
};

document.getElementById('fuenteDatos').onchange = () => {
  const tipo = document.getElementById('fuenteDatos').value;
  const tipoGrafico = document.getElementById('tipoGrafico');
  tipoGrafico.innerHTML = '<option value="">-- Selecciona --</option>';
  if (opcionesPorTabla[tipo]) {
    for (const key in opcionesPorTabla[tipo]) {
      const opt = document.createElement('option');
      opt.value = key;
      opt.innerText = opcionesPorTabla[tipo][key];
      tipoGrafico.appendChild(opt);
    }
  }
};

document.getElementById('btnGenerarGrafico').onclick = () => {
  const fuente = document.getElementById('fuenteDatos').value;
  const tipo = document.getElementById('tipoGrafico').value;

  if (!fuente || !tipo) {
    alert("Por favor selecciona fuente y tipo de gráfico.");
    return;
  }

  fetch(`graficos_datos.php?tabla=${fuente}&tipo=${tipo}`)
    .then(r => r.json())
    .then(cfg => {
      const ctx = document.getElementById('canvasGrafico').getContext('2d');
      if (graficoActual) graficoActual.destroy();
      graficoActual = new Chart(ctx, cfg);
    })
    .catch(err => {
      console.error(err);
      alert("❌ Error al cargar el gráfico.");
    });
};
</script>
</html>